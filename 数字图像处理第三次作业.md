# 数字图像处理第三次作业  
 * 姓名：王秦龙
 * 班级：自动化62
 * 学号：2160504048
 * 提交日期：2019/3/19

------

##摘要
&emsp;本次自主编程实现了对指定图片的直方图绘制，直方图均衡，直方图匹配，局部增强和阈值分割处理。实验地进行使我对于直方图均衡的本质有了更深入的理解，对直方图匹配方法有了更清晰的认识，同时在实验过程中，巩固了利用直方图局部增强的方法。本次实验基本都是自己编程实现的，提升了编程能力。

### 1.图像直方图处理    
&emsp;绘制每幅图像的直方图自己编程函数实现，主要需要统计每个灰度级别的像素数量并存入一个256维的数组中（所给图像均为256级的图像），然后利用bar函数绘制直方图即可，函数返回值为存储像素数量的数组。各图像绘制结果如下：  

![cmd-markdown](https://s2.ax1x.com/2019/03/18/AmIXQA.png)  

### 2.直方图均衡  
&emsp;直方图均衡就是实现$$s_k=\frac{L-1}{MN}\sum_{j=0}^{k}{n_j},  k=0,1,2,...L-1$$其中各灰度级的像素数量已经在直方图处理中求出，只需要完成相应的对应的像素转换，将原图像转为均衡后图像即可。直方图均衡代码如下：  
```matlab
function [ q ] =HE( x,yh )
%histogram equalization直方图均衡
%   x为图像矩阵，yh为直方图数组存储的是各灰度级像素数量
[M,N]=size(x);
MN=M*N;
S=zeros(256,1);%存储原来第k级别灰度对应的转换后灰度
for k=0:255
    s=0;
    for j=0:k
        s=s+yh(j+1);
    end
    S(k+1)=round(255*s/MN);
end
q=zeros(M,N);
for i=1:MN
    p=x(i)+1;
    q(i)=S(p);
end
imshow(uint8(q));
end
```  

&emsp;直方图均衡结果如下：  

![cmd-markdown](https://s2.ax1x.com/2019/03/18/AmoEyn.png)  

![cmd-markdown](https://s2.ax1x.com/2019/03/18/AmomwV.png)  

![cmd-markdown](https://s2.ax1x.com/2019/03/18/AmoKFU.png)  

![cmd-markdown](https://s2.ax1x.com/2019/03/18/Amo3l9.png)  
&emsp;**结果分析：**  
&emsp;lena原图均衡后的结果明显比原图更亮且对比度也提升了，从均衡后直方图也能看出来，直方图分布趋于均衡，lena2的均衡效果从直方图上反应的很好，原来较为集中的直方图变得分散在0到255上，lena1原图偏亮，均衡后一部分灰度级降低，整体的图像比原图变暗，lena3图像原本整体偏暗，均衡后，由直方图能看出，低灰度级的像素灰度有明显的台阶式提升，这是很好理解的，加和公式中由于k=0时的数值很大，导致结果整体变亮。从lena1和lena3我们能更好的理解直方图均衡，离散的均衡是在保证灰度级的大小关系不变时，使原有的像素数量分布改变（lena1和lena3的均衡结果中依然存在单峰现象），而不是将像素数量平均的分给各灰度级，因为后者会改变的图像的信息。其他几组图像的结果也类似。  

### 3.直方图匹配增强
&emsp;直方图的匹配是在直方图均衡的基础上实现的。观察这几组图片，原图都有比较好的表现性，所以将其他的几幅图像分别向他们的原图匹配。直方图匹配增强自编程实现，其中需要将两幅图像分别做直方图均衡，然后对两个均衡结果做选择匹配，因为是离散匹配存在偏差，所以总选择距离最近的值作为匹配值。匹配函数如下：  
```matlab
function [ o ] = match( x,y )
%histogram match 直方图匹配
%   x为要匹配的图像，y为拥有规定直方图的图像
%   矩阵从1开始256结束，所以像素值为0的像素个数为n（1）
n1=zeros(256,1);   %存储第i级灰度对应的像素个数
[M1,N1]=size(x);
for i=1:M1*N1
    r=x(i)+1;
    n1(r)=n1(r)+1;
end
n2=zeros(256,1);
[M2,N2]=size(y);
for i=1:M2*N2
    r=y(i)+1;
    n2(r)=n2(r)+1;
end

M1N1=M1*N1;
s1=zeros(256,1);%存储原来第k级别灰度对应的转换后灰度,x
M2N2=M2*N2;
s2=zeros(256,1);%存储原来第k级别灰度对应的转换后灰度,y
for k=0:255
    s=0;
    ss=0;
    for j=0:k
        s=s+n1(j+1); 
        ss=ss+n2(j+1);
    end
    s1(k+1)=round(255*s/M1N1);
    s2(k+1)=round(255*ss/M2N2);
end
%以上完成了两幅图像的直方图均衡，现在需要对均衡结果匹配，结果放在s3
s3=zeros(256,1);
for i=1:256
    for j=1:256
        if(s1(i)==s2(j))
            s3(i)=j;
            break;
        elseif((s1(i)>s2(j))&&(s1(i)<s2(j+1)))
            if((s1(i)-s2(j))<=(s2(j+1)-s1(i)))
                s3(i)=j;
                break;
            else
                s3(i)=j+1;
                break;
            end
        end
    end
end

o=zeros(M1,N1);
for i=1:M1N1
    p=x(i)+1;
    o(i)=s3(p);
end
imshow(uint8(o));%绘制匹配后的图像
end
```  

&emsp;匹配结果：  

![cmd-markdown](https://s2.ax1x.com/2019/03/18/AmTJ3Q.png)

![cmd-markdown](https://s2.ax1x.com/2019/03/18/AmTUun.png)

![cmd-markdown](https://s2.ax1x.com/2019/03/18/AmTdH0.png)

![cmd-markdown](https://s2.ax1x.com/2019/03/18/AmTBNT.png)

**匹配结果分析：**  
&emsp;将匹配结果和直方图均衡结果对比可以明显看到，直方图匹配后的结果普遍比直方图匹配的结果要暗。这是因为，直方图均衡更多的是将对比度在灰度级范围中拉伸了，而直方图匹配是将图片直方图向模板图像的直方图匹配，结果直方图分布更靠近模板图像。

### 4.直方图局部增强
&emsp;局部增强利用了直方图统计知识。局部直方图增强希望能增强图像的暗区域和低对比度的区域，因此需要设置增强的区域条件，这个条件是基于直方图统计的，区域均值区域方差和全局均值全局方差，通过设置区域均值和方差与全局均值和方差的关系确定出感兴趣区域。由于每个图像的直方图分布不同（影响均值和方差），所以对应不同图像要调整参数。增强的过程需要计算7*7模板中的局部均值和方差，自己实现过程中，将模板区域的值存入新的矩阵计算均值和方差。局部增强函数如下：  
```matlab
function [L] = local( P )
%7*7的局部直方图处理
%   利用全局均值u和全局方差c作为分割处理的基础
%计算均值和方差
p=double(P);
u=mean2(p);%全局均值
c=var(p(:));%全局方差
[M,N]=size(p);
a=zeros(M+6,N+6);%先补全矩阵，用于模板处理
L=zeros(M,N);%存放处理结果
for i=1:M
    for j=1:N
        a(i+3,j+3)=p(i,j);
    end
end
%对补全后的矩阵进行处理
A=zeros(7,7);%存放模板对应的矩阵值
for i=4:M+3
    for j=4:N+3
        k=1;
        for I=i-3:i+3    %计算7*7模板的均值和方差
            for J=j-3:j+3;
                A(k)=a(I,J);
                k=k+1;
            end
        end
        u1=mean2(A);%局部均值
        c1=var(A(:));%局部方差
        if((u1<0.8*u)&&(c1>0.05*c)&&(c1<0.7*c))% k0=0.8，k1=0.05，k2=0.7
            L(i-3,j-3)=4*a(i,j);
        else
            L(i-3,j-3)=a(i,j);
        end
    end
end
end
``` 

&emsp;局部增强结果图：  

![cmd-markdown](https://s2.ax1x.com/2019/03/18/AmHNT0.png)

![cmd-markdown](https://s2.ax1x.com/2019/03/18/AmHBpF.png)

&emsp;**局部增强结果分析**
&emsp;我们能看到局部增强的结果并不好，并没有预期的那么好，尤其是elain图像。原因分析如下:  

 * 由于模板太大，所以很那对暗区域的细节增强，因此看到增强结果图像中会有很粗的线条和块状区域
 * 参数设置并没有标准，很难找到一个很好的参数以达到理想效果

 ### 5.直方图图像分割  
&emsp;直方图分割是利用观察直方图设立一定的阈值对原图进行分割，一般阈值的设立选在直方图的谷底区域。可能存在多谷的情况，这是设定不同的分割阈值会得到不同的信息。分割函数如下：  
```matlab
function [ k ] = thresh( I,t )
%分割函数I为输入图像，t为设立的阈值
%   此处显示详细说明
 % 设全局阈值为t
[M, N] = size(I); 
K=zeros(M,N);
for i = 1 : M
   for j = 1 : N
      if ( I(i, j) > t)
          K(i, j) = 255;
      else
          K(i, j) = 0; 
      end
   end
end
k=uint8(K);
end
``` 
&emsp;分割结果图  

![cmd-markdown](https://s2.ax1x.com/2019/03/18/AmXBLQ.png)

![cmd-markdown](https://s2.ax1x.com/2019/03/18/AmXrZj.png)

&emsp;**分割结果分析**
&emsp;分割的结果因设置的阈值而异，观察elain图像的直方图不难发现，直方图中没有明显的低谷，所以分割结果并不理想，woman直方图有明显的低谷，分割结果相对较好。

------

**附录**


[1]: [美]Rafael C. Gonzalez 数字图像处理[M].阮秋琪,阮宇智等译.北京:电子工业出版社，2017.5 
[2]: 张德丰等著 Matlab数字图像处理[M].北京：机械工业出版社，2012.1


